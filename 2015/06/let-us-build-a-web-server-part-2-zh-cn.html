<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>让我们一起来构建一个 Web 服务器（二）</title>
  <meta name="author" content="mozillazg">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://mozillazg.com/favicon.png" rel="icon">
  <link href="https://mozillazg.com/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="https://mozillazg.com/theme/js/modernizr-2.0.js"></script>
  <script src="https://mozillazg.com/theme/js/ender.js"></script>
  <script src="https://mozillazg.com/theme/js/octopress.js" type="text/javascript"></script>

</head>

<body class="collapse-sidebar">
  <header role="banner"><hgroup>
  <h1><a href="https://mozillazg.com/">Mozillazg's Blog</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mozillazg.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<ul class="main-navigation">
    <li><a href="/index.html">Home</a></li>
      <li><a href="https://mozillazg.com/2014/10/pages/about-me.html">About me</a></li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">让我们一起来构建一个 Web 服务器（二）</h1>
      <p class="meta"><time datetime="2015-06-06T00:00:00+00:00" pubdate>周六 06 六月 2015</time></p>
</header>

  <div class="entry-content"><p>本文译自：<a class="reference external" href="http://ruslanspivak.com/lsbaws-part2/">http://ruslanspivak.com/lsbaws-part2/</a></p>
<p>还记得吗？在 <a class="reference external" href="http://mozillazg.com/2015/06/let-us-build-a-web-server-part-1-zh-cn.html">第一部分</a> 我向你问了一个问题：”如何在你新鲜出炉的 Web 服务器上不做任何修改的就运行 Django 应用，Flask 应用， Pyramid 应用?“
往下读就可以找到答案。</p>
<p>在过去，当你选择的 Python Web 框架会限制你所能选择的 Web 服务器, 如果那个框架和服务器被设计的可以一起工作的话，那就皆大欢喜了：</p>
<p><img alt="Server Framework Fit" src="/static/images/lsbaws-part2/lsbaws_part2_before_wsgi.png" /></p>
<p>但是，当你尝试把一个服务器和一个框架一起使用的时候可能会（可能你已经）面临它们被设计为不兼容的情况：</p>
<p><img alt="Server Framework Clash" src="/static/images/lsbaws-part2/lsbaws_part2_after_wsgi.png" /></p>
<p>一般来说你必须使用能够一起工作的组件而不仅仅是你想使用的组件。</p>
<p>那么，你如何确保你能够在你的 Web 服务器上运行多个 Web 框架，并且不需要修改 Web 服务器或 Web 框架的现有的代码呢？
解决这个问题的答案就是 Python Web Server Gateway Interface (或简称 WSGI , 读作 “wizgy”)</p>
<p><img alt="WSGI Interface" src="/static/images/lsbaws-part2/lsbaws_part2_wsgi_idea.png" /></p>
<p><a class="reference external" href="https://www.python.org/dev/peps/pep-0333/">WSGI</a> 允许开发者自由选择 Web 框架和 Web 服务器。现在你可以任意混搭不同的 Web 服务器和 Web 框架，并选择一个你需要的合适的组合。
比如，你可以 用 <a class="reference external" href="http://gunicorn.org/">Gunicorn</a> or <a class="reference external" href="http://uwsgi-docs.readthedocs.org/">Nginx/uWSGI</a> or <a class="reference external" href="http://waitress.readthedocs.org/">Waitress</a> 运行 <a class="reference external" href="https://www.djangoproject.com/">Django</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, 或 <a class="reference external" href="http://trypyramid.com/">Pyramid</a> .
真正的随意混搭，感谢那些服务器和框架对 WSGI 的支持：</p>
<p><img alt="Mix &amp; Match" src="/static/images/lsbaws-part2/lsbaws_part2_wsgi_interop.png" /></p>
<p>因此，<a class="reference external" href="https://www.python.org/dev/peps/pep-0333/">WSGI</a> 就是我在 <a class="reference external" href="http://mozillazg.com/2015/06/let-us-build-a-web-server-part-1-zh-cn.html">第一部分</a> 向你问的并在文章开头重复过的问题的答案。
你的 Web 服务器必须实现 WSGI 接口的服务器端部分，
所有的现代 Python Web 框架都已经实现了 WSGI 接口的框架端部分，
这部分允许你不需要修改你的服务器代码去适应某个特定的框架就可以使用这些框架。</p>
<p>现在你已经知道了被 Web 服务器和 Web 框架所支持的 WSGI 允许你选择适合你的组合，
它同样也对服务器和框架的开发者有益，因为他们可以专注于标准中他们各自的区域，不会出现因为越界而踩到对方的脚趾。
其他语言也有类似的接口：例如，Java 有 <a class="reference external" href="http://en.wikipedia.org/wiki/Java_servlet">Servlet API</a>，Ruby 有 <a class="reference external" href="http://en.wikipedia.org/wiki/Rack_%28web_server_interface%29">Rack</a>.</p>
<p>一切都很棒，但是我猜你会说”Show me the code!“，好吧，一起来看看下面这个非常简约的 WSGI 服务器实现吧：</p>
<div class="highlight"><pre><span class="c"># Tested with Python 2.7.9, Linux &amp; Mac OS X</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="k">class</span> <span class="nc">WSGIServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">address_family</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span>
    <span class="n">socket_type</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
    <span class="n">request_queue_size</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_address</span><span class="p">):</span>
        <span class="c"># Create a listening socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span> <span class="o">=</span> <span class="n">listen_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address_family</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span>
        <span class="p">)</span>
        <span class="c"># Allow to reuse the same address</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># Bind</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="c"># Activate</span>
        <span class="n">listen_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span><span class="p">)</span>
        <span class="c"># Get server host name and port</span>
        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="c"># Return headers set by Web framework/Web application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">application</span>

    <span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">listen_socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_socket</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c"># New client connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">listen_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="c"># Handle one request and close the client connection. Then</span>
            <span class="c"># loop over to wait for another client connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_one_request</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_one_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_data</span> <span class="o">=</span> <span class="n">request_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="c"># Print formatted request data a la &#39;curl -v&#39;</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s">&#39;&lt; {line}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">request_data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parse_request</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>

        <span class="c"># Construct environment dictionary using request data</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>

        <span class="c"># It&#39;s time to call our application callable and get</span>
        <span class="c"># back a result that will become HTTP response body</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">application</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>

        <span class="c"># Construct a response and send it back to the client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="c"># Break down the request line into components</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_method</span><span class="p">,</span>  <span class="c"># GET</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>            <span class="c"># /hello</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">request_version</span>  <span class="c"># HTTP/1.1</span>
         <span class="p">)</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># The following code snippet does not follow PEP8 conventions</span>
        <span class="c"># but it&#39;s formatted the way it is for demonstration purposes</span>
        <span class="c"># to emphasize the required variables and their values</span>
        <span class="c">#</span>
        <span class="c"># Required WSGI variables</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.version&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&#39;http&#39;</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_data</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.errors&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multithread&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">False</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;wsgi.run_once&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Required CGI variables</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_method</span>    <span class="c"># GET</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>              <span class="c"># /hello</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span>       <span class="c"># localhost</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_PORT&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>  <span class="c"># 8888</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Add necessary server headers</span>
        <span class="n">server_headers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Date&#39;</span><span class="p">,</span> <span class="s">&#39;Tue, 31 Mar 2015 12:54:48 GMT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Server&#39;</span><span class="p">,</span> <span class="s">&#39;WSGIServer 0.2&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span> <span class="o">+</span> <span class="n">server_headers</span><span class="p">]</span>
        <span class="c"># To adhere to WSGI specification the start_response must return</span>
        <span class="c"># a &#39;write&#39; callable. We simplicity&#39;s sake we&#39;ll ignore that detail</span>
        <span class="c"># for now.</span>
        <span class="c"># return self.finish_response</span>

    <span class="k">def</span> <span class="nf">finish_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers_set</span>
            <span class="n">response</span> <span class="o">=</span> <span class="s">&#39;HTTP/1.1 {status}</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">response_headers</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="s">&#39;{0}: {1}</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="c"># Print formatted response data a la &#39;curl -v&#39;</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s">&#39;&gt; {line}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="mi">8888</span>


<span class="k">def</span> <span class="nf">make_server</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">application</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;Provide a WSGI application object as module:callable&#39;</span><span class="p">)</span>
    <span class="n">app_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">module</span><span class="p">,</span> <span class="n">application</span> <span class="o">=</span> <span class="n">app_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
    <span class="n">application</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;WSGIServer: Serving HTTP on port {port} ...</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">))</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
<p>上面的代码比 <a class="reference external" href="http://mozillazg.com/2015/06/let-us-build-a-web-server-part-1-zh-cn.html">第一部分</a> 的服务器代码更长，但是，为了让你能够理解而不至于陷入细节的泥潭中，它已经足够小了（只有不到 150 行）。
上面的服务器代码同样也能做更多的工作——它能运行用你上面所见的 Web 框架（<a class="reference external" href="http://trypyramid.com/">Pyramid</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, <a class="reference external" href="https://www.djangoproject.com/">Django</a>, 或其他的 Python WSGI 框架）所写的基础 Web 应用，</p>
<p>不信？动手试一下吧。把上面的代码保存为 <tt class="docutils literal">webserver2.py</tt> 或者直接从 <a class="reference external" href="https://github.com/rspivak/lsbaws/blob/master/part2/webserver2.py">GitHub</a> 上下载下来。如果你不带任何参数就运行这个程序的话，它会向你抱怨，然后退出。</p>
<pre class="literal-block">
$ python webserver2.py
Provide a WSGI application object as module:callable
</pre>
<p>它真的非常想要服务你的 Web 应用，这是个非常有趣的开始。
为了能够运行这个服务器你只需要安装 Python 就可以了。
但是，为了运行用 <a class="reference external" href="http://trypyramid.com/">Pyramid</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, 或 <a class="reference external" href="https://www.djangoproject.com/">Django</a> 开发的应用，你需要首先安装这些框架。
让我们来安装这三个框架吧。
我喜欢使用 <a class="reference external" href="https://virtualenv.pypa.io/">virtualenv</a>. 只需按照下面的步骤去创建并激活一个虚拟环境，然后就可以安装这三个框架了。</p>
<pre class="literal-block">
$ [sudo] pip install virtualenv
$ mkdir ~/envs
$ virtualenv ~/envs/lsbaws/
$ cd ~/envs/lsbaws/
$ ls
bin  include  lib
$ source bin/activate
(lsbaws) $ pip install pyramid
(lsbaws) $ pip install flask
(lsbaws) $ pip install django
</pre>
<p>到这一步的时候你需要创建一个 Web 应用。让我们先用 <a class="reference external" href="http://trypyramid.com/">Pyramid</a> 开始吧。把下面的代码保存为 <tt class="docutils literal">pyramidapp.py</tt>  并放到你之前所保存的 <tt class="docutils literal">webserver2.py</tt> 文件或直接从 <a class="reference external" href="https://github.com/rspivak/lsbaws/blob/master/part2/pyramidapp.py">GitHub</a> 所下载的文件所在目录（即：把 <tt class="docutils literal">pyramidapp.py</tt> 放在 <tt class="docutils literal">webserver2.py</tt> 所在目录）：</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="s">&#39;Hello world from Pyramid!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;/hello&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
<p>现在，你可以准备用你自己的 Web 服务器来服务你的 Pyramid 应用了：</p>
<pre class="literal-block">
(lsbaws) $ python webserver2.py pyramidapp:app
WSGIServer: Serving HTTP on port 8888 ...
</pre>
<p>你只需告诉你的服务器从 python 模块 <tt class="docutils literal">pyramidapp</tt> 中载入一个可调用的 <tt class="docutils literal">app</tt> 对象，你的服务器现在已经准备好
接收请求并把它们转发给你的 Pyramid 应用了。
这个应用目前只处理了一个路由：<tt class="docutils literal">/hello</tt> 路由。
在你的浏览器中输入 <a class="reference external" href="http://localhost:8888/hello">http://localhost:8888/hello</a> 地址，然后按下回车键，注意返回的结果：</p>
<p><img alt="Pyramid" src="/static/images/lsbaws-part2/lsbaws_part2_browser_pyramid.png" /></p>
<p>你也可以在命令行中使用 <tt class="docutils literal">curl</tt> 命令来测试这个服务器：</p>
<pre class="literal-block">
$ curl -v http://localhost:8888/hello
...
</pre>
<p>检查服务器以及 <tt class="docutils literal">curl</tt> 打印到标准输出的内容。</p>
<p>现在轮到 <a class="reference external" href="http://flask.pocoo.org/">Flask</a> 了。让我们按照相同的步骤来操作。</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="n">flask_app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&#39;flaskapp&#39;</span><span class="p">)</span>


<span class="nd">@flask_app.route</span><span class="p">(</span><span class="s">&#39;/hello&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="s">&#39;Hello world from Flask!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span>
    <span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">flask_app</span><span class="o">.</span><span class="n">wsgi_app</span>
</pre></div>
<p>把上面的代码保存为 <tt class="docutils literal">flaskapp.py</tt>  或从 <a class="reference external" href="https://github.com/rspivak/lsbaws/blob/master/part2/flaskapp.py">GitHub</a> 上下载，然后用以下方式运行服务器:</p>
<pre class="literal-block">
(lsbaws) $ python webserver2.py flaskapp:app
WSGIServer: Serving HTTP on port 8888 ...
</pre>
<p>现在在你的浏览器中输入 <a class="reference external" href="http://localhost:8888/hello">http://localhost:8888/hello</a> 然后按下回车键：</p>
<p><img alt="Flask" src="/static/images/lsbaws-part2/lsbaws_part2_browser_flask.png" /></p>
<p>再一次，尝试 <tt class="docutils literal">curl</tt> 命令，然后看一下服务器返回的由这个 Flask 应用所生成的信息：</p>
<pre class="literal-block">
$ curl -v http://localhost:8888/hello
...
</pre>
<p>这个服务器能处理 <a class="reference external" href="https://www.djangoproject.com/">Django</a> 应用吗啊？试一下就知道了！
这次涉及的东西有点复杂，我建议你克隆这个 <a class="reference external" href="https://github.com/rspivak/lsbaws/">仓库</a> 然后使用  GitHub 仓库 中的 <a class="reference external" href="https://github.com/rspivak/lsbaws/blob/master/part2/djangoapp.py">djangoapp.py</a> 文件。
下面的源码主要是添加 Django <tt class="docutils literal">helloworld</tt> 项目（预先使用 Django 的 <tt class="docutils literal"><span class="pre">django-admin.py</span> startproject</tt> 命令）到当前 Python 路径
然后导入项目中的 WSGI 应用。</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;./helloworld&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">helloworld</span> <span class="kn">import</span> <span class="n">wsgi</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">application</span>
</pre></div>
<p>把上面的代码保存为 <tt class="docutils literal">djangoapp.py</tt>  然后用你的 Web 服务器运行这个 Django 应用：</p>
<pre class="literal-block">
(lsbaws) $ python webserver2.py djangoapp:app
WSGIServer: Serving HTTP on port 8888 ...
</pre>
<p>输入如下地址并回车：</p>
<p><img alt="Django" src="/static/images/lsbaws-part2/lsbaws_part2_browser_django.png" /></p>
<p>正如你之前做过的那几次一样，你也可以在命令行中进行测试。
确认这个 Django 应用处理了你这一次的请求：</p>
<pre class="literal-block">
$ curl -v http://localhost:8888/hello
...
</pre>
<p>你试过了吗？你有确认过这个服务器可以与这三个框架一起工作吗？
如果还没有的话，一定要试一下。
阅读很重要，但是这个系列讲的是关于重新构建，这意味着你需要手动进行这些尝试。
快去试试吧。别担心，我会等你的。
我是认真的，你必须去尝试，最好能够亲自一个字一个字的敲下所有的字符，
并确保它能达到预期的效果。</p>
<p>好了，你已经熟悉 WSGI 的威力了：它允许你混搭你的 Web 服务器和 Web 框架。
WSGI 规定了 Python Web 服务器和  Python Web 框架之间的一些接口。
它非常的简单，不管是在服务器还是框架端都非常容易实现。
下面的片段展示了服务器和框架端的接口：</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">run_application</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Server code.&quot;&quot;&quot;</span>
    <span class="c"># This is where an application/framework stores</span>
    <span class="c"># an HTTP status and HTTP response headers for the server</span>
    <span class="c"># to transmit to the client</span>
    <span class="n">headers_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c"># Environment dictionary with WSGI/CGI variables</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">headers_set</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">]</span>

    <span class="c"># Server invokes the ‘application&#39; callable and gets back the</span>
    <span class="c"># response body</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="c"># Server builds an HTTP response and transmits it to the client</span>
    <span class="err">…</span>

<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A barebones WSGI app.&quot;&quot;&quot;</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello world!&#39;</span><span class="p">]</span>

<span class="n">run_application</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
<p>它的工作原理是这样的：</p>
<ol class="arabic simple">
<li>框架提供了一个 <tt class="docutils literal">application</tt> 可调用对象（WSGI 规范没有规定它应该如何被实现）</li>
<li>每当收到来自 HTTP 客户端的请求的时候，服务器就调用这个 <tt class="docutils literal">application</tt> 可调用对象。
它把一个包含 WSGI/CGI 变量的字典 <tt class="docutils literal">environ</tt> 和一个 <tt class="docutils literal">start_response</tt> 可调用对象作为参数传递给了 <tt class="docutils literal">application</tt> 可调用对象。</li>
<li>框架/应用生成一个 HTTP 状态信息和 HTTP 响应头信息，并把它们传递给了 <tt class="docutils literal">start_response</tt> 可调用对象，
让服务器把它们存起来。框架/应用也返回了一个响应 body 信息。</li>
<li>服务器把状态信息，响应头信息以及响应 body 信息合并为一个 HTTP 响应，然后把它传输给客户端（这一步不是规范的一部分，
但是它是流程中的下一个逻辑步骤，为了清晰可见我把它列在了这里）</li>
</ol>
<p>下面是这个接口的可视化图表：</p>
<p><img alt="WSGI Interface Visual" src="/static/images/lsbaws-part2/lsbaws_part2_wsgi_interface.png" /></p>
<p>到目前位置，你已经见过了 <a class="reference external" href="http://trypyramid.com/">Pyramid</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a> 以及 <a class="reference external" href="https://www.djangoproject.com/">Django</a> Web 应用，你也见过了实现 WSGI 规范的服务器端代码。
你也见过不用任何框架所实现的极简 WSGI 应用的代码片段。</p>
<p>事实是，当你用这些框架中某个开发一个 Web 应用的时候，你是在高层面进行工作，
并没有直接与 WSGI 打交到，但是我知道非常好奇框架端的 WSGI 接口实现，也是因为你正在阅读这篇文章。
那么，让我们来创建一个不使用 <a class="reference external" href="http://trypyramid.com/">Pyramid</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, <a class="reference external" href="https://www.djangoproject.com/">Django</a> 的微型 WSGI Web 应用/Web 框架，
并用你的服务器来运行它：</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A barebones WSGI application.</span>

<span class="sd">    This is a starting point for your own Web framework :)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">&#39;Hello world from a simple WSGI application!</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">]</span>
</pre></div>
<p>再一次的，把上面的代码保存为 <tt class="docutils literal">wsgiapp.py</tt> 或直接从 <a class="reference external" href="https://github.com/rspivak/lsbaws/blob/master/part2/wsgiapp.py">GitHub</a> 上下载它，然后用你的
Web 服务器像下面这样运行这个应用：</p>
<pre class="literal-block">
(lsbaws) $ python webserver2.py wsgiapp:app
WSGIServer: Serving HTTP on port 8888 ...
</pre>
<p>输入如下地址并按下回车键。你应该会看到这样的结果：</p>
<p><img alt="Simple WSGI Application" src="/static/images/lsbaws-part2/lsbaws_part2_browser_simple_wsgi_app.png" /></p>
<p>在学习如何创建一个 Web 服务器的同时，你刚刚又写了一个你自己的微型 WSGI WEB 框架！
真是意外之喜！</p>
<p>现在，让我们回到服务器都给客户端传输了什么东西。
下面是当你使用 HTTP 客户端调用你的 Pyramind 应用时，服务器生成的 HTTP 响应：</p>
<p><img alt="HTTP Response Part 1" src="/static/images/lsbaws-part2/lsbaws_part2_http_response.png" /></p>
<p>这个响应有一些你在 <a class="reference external" href="http://mozillazg.com/2015/06/let-us-build-a-web-server-part-1-zh-cn.html">第一部分</a> 看到过的东西，但是它也有一些新东西。比如说，它有四个你之前还没见过的 <a class="reference external" href="http://en.wikipedia.org/wiki/List_of_HTTP_header_fields">HTTP headers</a>：
<tt class="docutils literal"><span class="pre">Content-Type</span></tt> , <tt class="docutils literal"><span class="pre">Content-Length</span></tt> , <tt class="docutils literal">Date</tt> 以及 <tt class="docutils literal">Server</tt> .
这些包含在响应里的头信息是一个 Web 服务器应该要生成的信息。
虽然它们中没有一个是严格要求必须提供的。
这些头信息的目的是传输关于 HTTP 请求/响应的附加信息。</p>
<p>现在你已经了解了关于 WSGI 接口的更详细的信息了，下面是同一个 HTTP 响应部分是如何产生的更详细的信息：</p>
<p><img alt="HTTP Response Part 2" src="/static/images/lsbaws-part2/lsbaws_part2_http_response_explanation.png" /></p>
<p>我还没有说过任何有关 <tt class="docutils literal">environ</tt> 字典相关的信息，但是，基本上就是它是一个 Python 字典，它必须包含某些由 WSGI 规范所规定的 WSGI 和 CGI 变量。
解析完请求信息后，服务器从 HTTP 请求中得到这个字典所需的一些值。
这个字典看起来像下面这样：</p>
<p><img alt="Environ Python Dictionary" src="/static/images/lsbaws-part2/lsbaws_part2_environ.png" /></p>
<p>Web 框架使用来自这个字典里的信息来决定那个 view 可以被用来服务，基于获得的路由，请求方法等信息,
决定可以从哪里读取请求的 body 信息以及哪里可以用来写入错误信息，如果有的话。</p>
<p>到目前为止，你已经创建了你自己的 WSGI Web 服务器，你也用不同的 Web 框架编写过 Web 应用了。同时，你也顺便创建过极其简陋的 Web 应用/Web 框架。
真是一个操蛋的旅程。让我们来重述一下为了服务一个针对 WSGI 应用的请求信息，你的 WSGI Web 框架需要做的事情：</p>
<ol class="arabic simple">
<li>首先，服务器启动并载入一个由你的 Web 框架/应用所定义的 <tt class="docutils literal">application</tt> 可调用对象</li>
<li>然后，服务器读取一个请求</li>
<li>然后，服务器解析这个请求</li>
<li>然后，服务器用这个请求数据构建了一个 <tt class="docutils literal">environ</tt> 字典</li>
<li>然后，服务器以 <tt class="docutils literal">environ</tt> 字典和一个 <tt class="docutils literal">start_response</tt> 可调用对象作为参数来调用 <tt class="docutils literal">application</tt> 对象，并获得一个返回的响应 body 。</li>
<li>然后，服务器用通过调用 <tt class="docutils literal">application</tt> 对象获得的 body 数据以及通过 <tt class="docutils literal">start_reponse</tt> 可调用对象设置的状态信息和响应头信息一起构建了一个 HTTP 响应。</li>
<li>最后，服务器把 HTTP 响应传输回客户端</li>
</ol>
<p><img alt="Server Summary" src="/static/images/lsbaws-part2/lsbaws_part2_server_summary.png" /></p>
<p>就这些了。你现在有了一个可以工作的 WSGI 服务器，它能够服务那些用 WSGI 兼容的 Web 框架（比如：<a class="reference external" href="https://www.djangoproject.com/">Django</a>, <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, <a class="reference external" href="http://trypyramid.com/">Pyramid</a> 或者是你自己开发的 WSGI 框架) 开发的基础的 Web 应用。最棒的是不需要修改任何的服务器代码就可以与多个 Web 框架一起使用。目前看起来还不赖嘛。</p>
<p>在你离开前，这里有另一个问题需要你思考，”如何让你的服务器能够在同一时刻处理多个请求？“</p>
<p>敬请期待，在 <a class="reference external" href="https://mozillazg.com/2015/08/let-us-build-a-web-server-part-3-zh-cn.html">第三部分</a> 我将向你展示一种方法。加油！</p>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">mozillazg</span>
  </span>
<time datetime="2015-06-06T00:00:00+00:00" pubdate>周六 06 六月 2015</time>
  <span class="categories">posted in
  <a class='category' href='/category/python.html'>python</a>
tags:
    <a class="category" href="https://mozillazg.com/tag/server.html">server</a>
    <a class="category" href="https://mozillazg.com/tag/http.html">http</a>
    <a class="category" href="https://mozillazg.com/tag/wsgi.html">wsgi</a>
    <a class="category" href="https://mozillazg.com/tag/lsbaws.html">lsbaws</a>
    <a class="category" href="https://mozillazg.com/tag/rang-wo-men-qi-lai-gou-jian-ge-web-fu-wu-qi.html">让我们一起来构建一个 Web 服务器</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="https://mozillazg.com/2016/03/let-us-build-a-template-engine-part3.html">让我们一起来构建一个模板引擎（三）</a>
      </li>
      <li class="post">
          <a href="https://mozillazg.com/2016/03/4244.thinnerpills.zh-cn.html">Cyanide & Happiness #4244：减肥药</a>
      </li>
      <li class="post">
          <a href="https://mozillazg.com/2016/03/84.thisistheend.zh-cn.html">Victims of Circumsolar：这是结局</a>
      </li>
      <li class="post">
          <a href="https://mozillazg.com/2016/03/let-us-build-a-template-engine-part2.html">让我们一起来构建一个模板引擎（二）</a>
      </li>
      <li class="post">
          <a href="https://mozillazg.com/2016/03/2191.doyoulikeme.zh-cn.html">Cyanide & Happiness #2191：你喜欢我吗</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="https://mozillazg.com/category/comics.html">comics</a></li>
        <li><a href="https://mozillazg.com/category/database.html">database</a></li>
        <li><a href="https://mozillazg.com/category/django.html">django</a></li>
        <li><a href="https://mozillazg.com/category/docker.html">docker</a></li>
        <li><a href="https://mozillazg.com/category/english.html">english</a></li>
        <li><a href="https://mozillazg.com/category/firefox.html">firefox</a></li>
        <li><a href="https://mozillazg.com/category/flask.html">flask</a></li>
        <li><a href="https://mozillazg.com/category/git.html">git</a></li>
        <li><a href="https://mozillazg.com/category/go.html">go</a></li>
        <li><a href="https://mozillazg.com/category/javascript.html">javascript</a></li>
        <li><a href="https://mozillazg.com/category/linux.html">linux</a></li>
        <li><a href="https://mozillazg.com/category/mongodb.html">mongodb</a></li>
        <li><a href="https://mozillazg.com/category/others.html">others</a></li>
        <li><a href="https://mozillazg.com/category/peewee.html">peewee</a></li>
        <li><a href="https://mozillazg.com/category/python.html">python</a></li>
        <li><a href="https://mozillazg.com/category/reading.html">reading</a></li>
        <li><a href="https://mozillazg.com/category/tornado.html">tornado</a></li>
        <li><a href="https://mozillazg.com/category/web.html">web</a></li>
        <li><a href="https://mozillazg.com/category/windows.html">windows</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="https://mozillazg.com/tag/wsgi.html">wsgi</a>,    <a href="https://mozillazg.com/tag/zope2.html">zope2</a>,    <a href="https://mozillazg.com/tag/python-third-party-model.html">python-third-party-model</a>,    <a href="https://mozillazg.com/tag/pelican.html">pelican</a>,    <a href="https://mozillazg.com/tag/commitstrip.html">CommitStrip</a>,    <a href="https://mozillazg.com/tag/tiao-ban-ji.html">跳板机</a>,    <a href="https://mozillazg.com/tag/python-markdown.html">python-markdown</a>,    <a href="https://mozillazg.com/tag/datetime.html">datetime</a>,    <a href="https://mozillazg.com/tag/sanbox.html">sanbox</a>,    <a href="https://mozillazg.com/tag/vsftp.html">vsftp</a>,    <a href="https://mozillazg.com/tag/unicode.html">unicode</a>,    <a href="https://mozillazg.com/tag/mysql.html">mysql</a>,    <a href="https://mozillazg.com/tag/flask-restful.html">Flask-RESTful</a>,    <a href="https://mozillazg.com/tag/web.html">web</a>,    <a href="https://mozillazg.com/tag/generator.html">generator</a>,    <a href="https://mozillazg.com/tag/flask.html">flask</a>,    <a href="https://mozillazg.com/tag/psycopg2.html">psycopg2</a>,    <a href="https://mozillazg.com/tag/celery.html">celery</a>,    <a href="https://mozillazg.com/tag/sqldeveloper.html">sqldeveloper</a>,    <a href="https://mozillazg.com/tag/iptables.html">iptables</a>,    <a href="https://mozillazg.com/tag/python.html">python</a>,    <a href="https://mozillazg.com/tag/useradmin.html">UserAdmin</a>,    <a href="https://mozillazg.com/tag/framework.html">framework</a>,    <a href="https://mozillazg.com/tag/ssh.html">ssh</a>,    <a href="https://mozillazg.com/tag/fab.html">fab</a>,    <a href="https://mozillazg.com/tag/sorted.html">sorted</a>,    <a href="https://mozillazg.com/tag/zope.html">zope</a>,    <a href="https://mozillazg.com/tag/decorator.html">decorator</a>,    <a href="https://mozillazg.com/tag/sorting.html">sorting</a>,    <a href="https://mozillazg.com/tag/summernote.html">Summernote</a>,    <a href="https://mozillazg.com/tag/gitlab.html">gitlab</a>,    <a href="https://mozillazg.com/tag/list.html">list</a>,    <a href="https://mozillazg.com/tag/server.html">server</a>,    <a href="https://mozillazg.com/tag/mitmproxy.html">mitmproxy</a>,    <a href="https://mozillazg.com/tag/merge.html">merge</a>,    <a href="https://mozillazg.com/tag/rang-wo-men-qi-lai-gou-jian-ge-mo-ban-yin-qing.html">让我们一起来构建一个模板引擎</a>,    <a href="https://mozillazg.com/tag/lsbaws.html">lsbaws</a>,    <a href="https://mozillazg.com/tag/pdfjs.html">pdf.js</a>,    <a href="https://mozillazg.com/tag/multiprocessing.html">multiprocessing</a>,    <a href="https://mozillazg.com/tag/list_display.html">list_display</a>,    <a href="https://mozillazg.com/tag/postpresql.html">postpresql</a>,    <a href="https://mozillazg.com/tag/centos.html">centos</a>,    <a href="https://mozillazg.com/tag/zhong-wen-fan-yi.html">中文翻译</a>,    <a href="https://mozillazg.com/tag/yi-dong-duan-kai-fa.html">移动端开发</a>,    <a href="https://mozillazg.com/tag/auto-increment.html">auto-increment</a>,    <a href="https://mozillazg.com/tag/vmware.html">VMware</a>,    <a href="https://mozillazg.com/tag/dateutil.html">dateutil</a>,    <a href="https://mozillazg.com/tag/querydict.html">querydict</a>,    <a href="https://mozillazg.com/tag/replication.html">replication</a>,    <a href="https://mozillazg.com/tag/python-3.html">python 3</a>,    <a href="https://mozillazg.com/tag/template.html">template</a>,    <a href="https://mozillazg.com/tag/foreign-key.html">foreign-key</a>,    <a href="https://mozillazg.com/tag/memcached.html">memcached</a>,    <a href="https://mozillazg.com/tag/email.html">email</a>,    <a href="https://mozillazg.com/tag/wireshark.html">wireshark</a>,    <a href="https://mozillazg.com/tag/weinre.html">weinre</a>,    <a href="https://mozillazg.com/tag/gunicorn.html">gunicorn</a>,    <a href="https://mozillazg.com/tag/sendmail.html">sendmail</a>,    <a href="https://mozillazg.com/tag/web-quan-zhan-gong-cheng-shi-de-zi-wo-xiu-yang.html">Web 全栈工程师的自我修养</a>,    <a href="https://mozillazg.com/tag/screen.html">screen</a>,    <a href="https://mozillazg.com/tag/javascript.html">javascript</a>,    <a href="https://mozillazg.com/tag/orm.html">orm</a>,    <a href="https://mozillazg.com/tag/ubuntu.html">ubuntu</a>,    <a href="https://mozillazg.com/tag/apache.html">apache</a>,    <a href="https://mozillazg.com/tag/bash.html">bash</a>,    <a href="https://mozillazg.com/tag/postgresql.html">postgresql</a>,    <a href="https://mozillazg.com/tag/socket.html">socket</a>,    <a href="https://mozillazg.com/tag/cyanide-and-happiness.html">Cyanide and Happiness</a>,    <a href="https://mozillazg.com/tag/admin.html">admin</a>,    <a href="https://mozillazg.com/tag/rang-wo-men-qi-lai-gou-jian-ge-web-fu-wu-qi.html">让我们一起来构建一个 Web 服务器</a>,    <a href="https://mozillazg.com/tag/jwt.html">jwt</a>,    <a href="https://mozillazg.com/tag/django-rq.html">django-rq</a>,    <a href="https://mozillazg.com/tag/yum.html">yum</a>,    <a href="https://mozillazg.com/tag/thread-locals.html">Thread-Locals</a>,    <a href="https://mozillazg.com/tag/router.html">router</a>,    <a href="https://mozillazg.com/tag/wei-xin.html">微信</a>,    <a href="https://mozillazg.com/tag/pillow.html">pillow</a>,    <a href="https://mozillazg.com/tag/south.html">south</a>,    <a href="https://mozillazg.com/tag/phpmyadmin.html">phpmyadmin</a>,    <a href="https://mozillazg.com/tag/markdown.html">markdown</a>,    <a href="https://mozillazg.com/tag/firefox.html">firefox</a>,    <a href="https://mozillazg.com/tag/color.html">color</a>,    <a href="https://mozillazg.com/tag/gitlab-git-http-server.html">gitlab-git-http-server</a>,    <a href="https://mozillazg.com/tag/search_fields.html">search_fields</a>,    <a href="https://mozillazg.com/tag/pygments.html">pygments</a>,    <a href="https://mozillazg.com/tag/linux.html">linux</a>,    <a href="https://mozillazg.com/tag/gateway.html">gateway</a>,    <a href="https://mozillazg.com/tag/terminal.html">terminal</a>,    <a href="https://mozillazg.com/tag/git.html">git</a>,    <a href="https://mozillazg.com/tag/fabric.html">fabric</a>,    <a href="https://mozillazg.com/tag/flask-sqlalchemy.html">flask-sqlalchemy</a>,    <a href="https://mozillazg.com/tag/buttersafe.html">buttersafe</a>,    <a href="https://mozillazg.com/tag/rpmforge.html">rpmforge</a>,    <a href="https://mozillazg.com/tag/redmine.html">redmine</a>,    <a href="https://mozillazg.com/tag/mongodbshu-ju-ku.html">MongoDB，数据库</a>,    <a href="https://mozillazg.com/tag/tcpdump.html">tcpdump</a>,    <a href="https://mozillazg.com/tag/valueerror.html">ValueError</a>,    <a href="https://mozillazg.com/tag/fastcgi.html">fastcgi</a>,    <a href="https://mozillazg.com/tag/sort.html">sort</a>,    <a href="https://mozillazg.com/tag/shell.html">shell</a>,    <a href="https://mozillazg.com/tag/form.html">form</a>,    <a href="https://mozillazg.com/tag/pinyin.html">pinyin</a>,    <a href="https://mozillazg.com/tag/goroutine.html">goroutine</a>,    <a href="https://mozillazg.com/tag/man-hua.html">漫画</a>,    <a href="https://mozillazg.com/tag/explosmnet.html">Explosm.net</a>,    <a href="https://mozillazg.com/tag/python-dateutil.html">python-dateutil</a>,    <a href="https://mozillazg.com/tag/lsbate.html">lsbate</a>,    <a href="https://mozillazg.com/tag/psql.html">psql</a>,    <a href="https://mozillazg.com/tag/thread.html">thread</a>,    <a href="https://mozillazg.com/tag/x-priority.html">X-Priority</a>,    <a href="https://mozillazg.com/tag/comics.html">comics</a>,    <a href="https://mozillazg.com/tag/verbose_name_plural.html">verbose_name_plural</a>,    <a href="https://mozillazg.com/tag/function-annotations.html">Function Annotations</a>,    <a href="https://mozillazg.com/tag/tu-jie-http.html">图解 HTTP</a>,    <a href="https://mozillazg.com/tag/berkeley-mews.html">Berkeley Mews</a>,    <a href="https://mozillazg.com/tag/fork.html">fork</a>,    <a href="https://mozillazg.com/tag/pil.html">pil</a>,    <a href="https://mozillazg.com/tag/ying-yu.html">英语</a>,    <a href="https://mozillazg.com/tag/queryset.html">queryset</a>,    <a href="https://mozillazg.com/tag/libxml.html">libxml</a>,    <a href="https://mozillazg.com/tag/sqlalchemy.html">sqlalchemy</a>,    <a href="https://mozillazg.com/tag/libxslt.html">libxslt</a>,    <a href="https://mozillazg.com/tag/bigintegerfield.html">BigIntegerField</a>,    <a href="https://mozillazg.com/tag/vps.html">vps</a>,    <a href="https://mozillazg.com/tag/threading.html">threading</a>,    <a href="https://mozillazg.com/tag/excel.html">excel</a>,    <a href="https://mozillazg.com/tag/flotr2.html">flotr2</a>,    <a href="https://mozillazg.com/tag/tubeytoons.html">Tubeytoons</a>,    <a href="https://mozillazg.com/tag/csv.html">csv</a>,    <a href="https://mozillazg.com/tag/verbose_name.html">verbose_name</a>,    <a href="https://mozillazg.com/tag/mod_wsgi.html">mod_wsgi</a>,    <a href="https://mozillazg.com/tag/http.html">http</a>,    <a href="https://mozillazg.com/tag/exec.html">exec</a>,    <a href="https://mozillazg.com/tag/yi-hua.html">汉化</a>,    <a href="https://mozillazg.com/tag/victims-of-circumsolar.html">Victims of Circumsolar</a>,    <a href="https://mozillazg.com/tag/ansi.html">ansi</a>,    <a href="https://mozillazg.com/tag/lxml.html">lxml</a>,    <a href="https://mozillazg.com/tag/wechat.html">wechat</a>,    <a href="https://mozillazg.com/tag/cygwin.html">Cygwin</a>,    <a href="https://mozillazg.com/tag/zhuang-shi-qi.html">装饰器</a>,    <a href="https://mozillazg.com/tag/loading-artist.html">Loading Artist</a>,    <a href="https://mozillazg.com/tag/rq.html">rq</a>,    <a href="https://mozillazg.com/tag/argparse.html">argparse</a>,    <a href="https://mozillazg.com/tag/github.html">github</a>,    <a href="https://mozillazg.com/tag/high-performance-django.html">High Performance Django</a>,    <a href="https://mozillazg.com/tag/nginx.html">nginx</a>,    <a href="https://mozillazg.com/tag/windows.html">windows</a>,    <a href="https://mozillazg.com/tag/django.html">django</a>,    <a href="https://mozillazg.com/tag/alembic.html">alembic</a>,    <a href="https://mozillazg.com/tag/english.html">english</a>,    <a href="https://mozillazg.com/tag/send_mail.html">send_mail</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="https://github.com/mozillazg" target="_blank">Fork me on GitHub</a></li>
            <li><a href="https://comic.mozillazg.com" target="_blank">Comics</a></li>
            <li><a href="https://mozillazg.com/feeds/all.atom.xml" target="_blank">Atom Feed</a></li>
            <li><a href="https://mozillazg.com/feeds/all.rss.xml" target="_blank">RSS Feed</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://docs.notmyidea.org/alexis/pelican/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org" target="_blank">Jinja2</a></li>
        </ul>
    </section>

<section>
    <p>Follow <a href="http://twitter.com/mozillazg">@mozillazg</a></p>
</section>
</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2016  - mozillazg -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
	<script type="text/javascript">
	  var disqus_shortname = 'my-github-blog';
          var disqus_identifier = '/2015/06/let-us-build-a-web-server-part-2-zh-cn.html';
          var disqus_url = 'https://mozillazg.com/2015/06/let-us-build-a-web-server-part-2-zh-cn.html';
          var disqus_title = '让我们一起来构建一个 Web 服务器（二）';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>